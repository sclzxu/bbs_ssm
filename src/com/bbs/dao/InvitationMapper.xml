<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bbs.dao.InvitationMapper">
	<resultMap type="Invitation" id="invitationMap">
		<id property="invitationId" column="invitationId"/>
		<result property="isPass" column="invitationIsPass"/>
		<result property="isEnable" column="invitationIsEnable"/>
		<association property="user" javaType="User">
			<id property="userId" column="userId"/>
		</association>
		<association property="plate" javaType="Plate">
			<id property="plateId" column="plateId"/>
		</association>
		<association property="category" javaType="Category">
			<id property="categoryId" column="categoryId"/>
		</association>
	</resultMap>
	<!-- 根据分类 id 查找对应的所有的贴子列表 -->
	<select id="findAllInvitationByCategoryId" resultType="Invitation">
		select * from bbs_invitation where categoryId=#{categoryId}
	</select>
	<!-- 添加新的贴子 -->
	<insert id="addNewInvitation" parameterType="Invitation">
		insert into bbs_invitation(invitationId,invitationTitle,invitationMessage,userId,
			plateId,categoryId,invitationCreate) 
			values(#{invitationId},#{invitationTitle},#{invitationMessage},
			#{user.userId},#{plate.plateId},#{category.categoryId},#{invitationCreate})
	</insert>
	<!-- 获取所有的贴子 -->
	<select id="findAllInvitations" resultMap="invitationMap">
		select invitationId,invitationTitle,invitationMessage,bbs_invitation.userId,
			bbs_invitation.plateId,bbs_invitation.categoryId,
			bbs_invitation.isPass invitationIsPass,
			bbs_invitation.isEnable invitationIsEnable,
			invitationCreate,invitationModify,plateTitle,userAlice,category
			from bbs_invitation left join bbs_user 
			on bbs_invitation.userId=bbs_user.userId
			left join bbs_plate on bbs_invitation.plateId=bbs_plate.plateId
			left join bbs_category on bbs_invitation.categoryId=bbs_category.categoryId
			where bbs_invitation.isPass=#{isPass}
			<if test="plateId!=null and plateId!=0">
				and bbs_plate.plateId=#{plateId}
			</if>
			<if test="categoryId!=null and categoryId!=0 and categoryId!=-1">
				and bbs_category.categoryId=#{categoryId}
			</if>
	</select>
	<!-- 根据 invitationId 查找 Invitation -->
	<select id="findInvitationById" parameterType="string" resultMap="invitationMap">
		select invitationId,invitationTitle,invitationMessage,bbs_invitation.userId,
			bbs_invitation.plateId,bbs_invitation.categoryId,
			bbs_invitation.isPass invitationIsPass,
			bbs_invitation.isEnable invitationIsEnable,
			invitationCreate,invitationModify,plateTitle,userAlice,category,
			userPhoto
			from bbs_invitation left join bbs_user 
			on bbs_invitation.userId=bbs_user.userId
			left join bbs_plate on bbs_invitation.plateId=bbs_plate.plateId
			left join bbs_category on bbs_invitation.categoryId=bbs_category.categoryId
			where bbs_invitation.invitationId=#{invitationId}
	</select>
	<!-- 根据 invitationId 修改 isPass -->
	<update id="updateIsPassById">
		update bbs_invitation set isPass=#{isPass} where invitationId=#{invitationId}
	</update>
	<!-- 通过 invitationId 修改 accessCount 增加1 -->
	<update id="updateAccessCountById" parameterType="string">
		update bbs_invitation set accessCount=accessCount+1 where invitationId=#{invitationId}
	</update>
	<!-- 获取所有热门贴子 -->
	<select id="findAllHotInvitations" resultMap="invitationMap">
		select invitationId,invitationTitle,invitationMessage,bbs_invitation.userId,
			bbs_invitation.plateId,bbs_invitation.categoryId,
			bbs_invitation.isPass invitationIsPass,
			bbs_invitation.isEnable invitationIsEnable,
			invitationCreate,invitationModify,plateTitle,userAlice,category
			from bbs_invitation left join bbs_user 
			on bbs_invitation.userId=bbs_user.userId
			left join bbs_plate on bbs_invitation.plateId=bbs_plate.plateId
			left join bbs_category on bbs_invitation.categoryId=bbs_category.categoryId
			where bbs_invitation.isPass=1
			and bbs_invitation.invitationId in(
				select bbs_invitation_inter.invitationId from bbs_invitation_inter
					group by bbs_invitation_inter.invitationId 
					having count(*)>=10
			)
	</select>
</mapper>



